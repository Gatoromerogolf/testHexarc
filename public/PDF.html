<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluación de riesgos</title>
    <script src="https://cdn.jsdelivr.net/npm/gaugeJS/dist/gauge.min.js"></script>
    <link href="../estilos/estiloEncuestas.css" rel="stylesheet">
    <!-- <link href="css/st-gobCorpo.css" rel="stylesheet"> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Abel&family=Barlow+Condensed:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Courgette&family=Gupter:wght@400;500;700&family=PT+Sans+Narrow:wght@400;700&family=Roboto+Condensed:ital,wght@0,100..900;1,100..900&family=Roboto+Serif:ital,opsz,wght@0,8..144,100..900;1,8..144,100..900&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>

<body>
    <div class="survey-container">
        <section class="main">
            <section class="gobCorpo">
                <div class="header-container">
                    <div class="header-center">
                        <div id="nombreEmpresa" class="company-name"></div>
                        <div id="nombreUsuario" class="user-name"></div>
                    </div>
                    <div class="nav-iconsxx">
                        <h4> A - Manejo de los Riesgos de Gobierno Corporativo</h4>
                    </div>
                    <div class="nav-iconsxx">
                        <h5> Autoevaluación</h5>
                    </div>
                </div>
                <hr>

                <form id="formulario">
                    <div class="center-container">
                        <h4 class="tituloSeccion"><a href="Menu-A.html">II - Estructura organizacional</a></h4>
                    </div>

                    <div class="centrado-flex">
                        <button type="submit" id="boton-enviar">Generar</button>
                        <button type="button" id="boton-generar-pdf">Generar PDF</button>
                    </div>
                </form>
            </section>
        </section>
    </div>
</body>


<!-- https://claude.ai/chat/da1b05d0-f15d-487d-bd62-f4f05b81c356
https://claude.ai/login?returnTo=%2F%3F
El tamaño de una hoja A4 es de 210 x 297 milímetros, es decir, 21 centímetros de ancho por 29,7 centímetros de largo.  -->

<script>

    const idioma = localStorage.getItem("idioma");
    const CUIT = localStorage.getItem("CUIT");
    let max = 90;

    const textoTipificacion = localStorage.getItem("textoTipificacion");
    const tipificacion = localStorage.getItem("tipificacion");

    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("boton-generar-pdf").addEventListener("click", generarPDF);
    });

    async function generarPDF() {

        textoCheck = await leeTextoCheck();
        textoRespuestas = await leeTextoRespuestas();

        const opciones = {
            margin: 0,
            filename: 'documento.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        // Crear un elemento temporal para construir el contenido HTML
        const contenido = document.createElement('div');

        const primeraPagina = document.createElement('div');
        primeraPagina.style.width = 'calc(100% - 20mm)'; // Ancho ajustado para márgenes
        primeraPagina.style.height = '277mm'; // Altura A4 menos márgenes
        primeraPagina.style.margin = '10mm';
        primeraPagina.style.border = '1px solid #000';
        // primeraPagina.style.backgroundImage = 'url("../img/imagenPDF.webp")';
        // primeraPagina.style.backgroundImage = 'url("../img/imagenPDF2.png")';
        // primeraPagina.style.backgroundImage = 'url("../img/imagenPDF3.png")';
        primeraPagina.style.backgroundImage = 'url("../img/imagenEdificios.webp")';
        primeraPagina.style.backgroundSize = 'contain';
        primeraPagina.style.backgroundPosition = 'center';
        primeraPagina.style.pageBreakAfter = 'always';

        const tituloCaratula = document.createElement('h1');
        tituloCaratula.textContent = 'Índice General';
        tituloCaratula.style.textAlign = 'center';
        tituloCaratula.style.fontFamily = 'Helvetica, Arial, sans-serif';
        tituloCaratula.style.fontSize = '26pt';
        tituloCaratula.style.color = 'white';
        // tituloCaratula.style.textShadow = '2px 2px 4px rgba(0, 0, 0, 0.5)';
        tituloCaratula.style.textShadow = '2px 2px 4px rgba(0, 0, 0, 0.5), -2px -2px 4px rgba(255, 255, 255, 0.3)';
        tituloCaratula.style.marginTop = '40mm';
        tituloCaratula.innerHTML = "Aplicación del Modelo HEXA RCi"
        primeraPagina.appendChild(tituloCaratula);

        contenido.appendChild(primeraPagina);

        // ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
        // ♦ Añadir la segunda página (índice)
        // ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
        const paginaIndice = crearPaginaConMarco();

        const tituloIndice = document.createElement('h1');
        tituloIndice.textContent = 'Índice General';
        tituloIndice.style.textAlign = 'center';
        tituloIndice.style.fontFamily = 'Helvetica, Arial, sans-serif';
        paginaIndice.appendChild(tituloIndice);

        const indice = ["Introducción: Optimización Empresarial y Gestión de Riesgos",
            "El Modelo HexaRCi",
            "Aplicación del Modelo y Conclusiones",
            "Representación gráfica",
            "Recomendaciones.  Oportunidades de mejora"];
        const listaIndice = document.createElement('ol');
        listaIndice.style.marginTop = '5mm';
        listaIndice.style.fontFamily = 'Helvetica, Arial, sans-serif';

        indice.forEach(item => {
            const elementoLista = document.createElement('li');
            elementoLista.textContent = item;
            elementoLista.style.marginBottom = '5mm';
            listaIndice.appendChild(elementoLista);
        });

        paginaIndice.appendChild(listaIndice);

        parrafo = document.createElement('p');
        parrafo.style.fontFamily = 'Helvetica, Arial, sans-serif';
        parrafo.style.fontSize = '11pt';
        parrafo.style.lineHeight = '1.5';
        parrafo.style.fontStyle = 'italic'; // Agregar estilo itálico
        parrafo.style.marginTop = '150mm';
        parrafo.innerHTML = "De acuerdo con los términos de la Propuesta de servicios profesionales de BDT Advisory LLC para BDT Advisory del Sistema HexaRCi, el presente informe tiene el ámbito de uso reservado previsto en la misma."
        paginaIndice.appendChild(parrafo);

        contenido.appendChild(paginaIndice);




        // ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
        // ♦ Añadir la tercera página (contenido) con un borde
        // ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
        const terceraPagina = crearPaginaConMarco();

        const tituloTercera = document.createElement('p');
        tituloTercera.innerHTML = "Introducción: Optimización Empresarial y Gestión de Riesgos";
        tituloTercera.style.fontFamily = 'Helvetica, Arial, sans-serif';
        tituloTercera.style.fontSize = '16pt';
        tituloTercera.style.fontWeight = 'bold';
        tituloTercera.style.textAlign = 'center';
        tituloTercera.style.marginTop = '5mm';
        terceraPagina.appendChild(tituloTercera);

        parrafo = document.createElement('p');
        parrafo.style.fontFamily = 'Helvetica, Arial, sans-serif';
        parrafo.style.fontSize = '13pt';
        parrafo.style.lineHeight = '1.5';
        parrafo.innerHTML = "En el dinámico escenario empresarial actual, las organizaciones enfrentan el desafío constante de incrementar su rentabilidad y mantener una posición competitiva sólida. Este objetivo fundamental requiere una comprensión profunda y un manejo estratégico de los diversos factores de riesgo que pueden impactar el desempeño y la sostenibilidad del negocio.<br><br>Cada estructura empresarial aspira a un modelo de organización y funcionamiento ideal, un esquema que maximice la eficiencia operativa y minimice la exposición a riesgos potenciales. Sin embargo, alcanzar este estado óptimo no es un proceso simple, sino un ejercicio complejo de análisis, evaluación y adaptación continua.<br><br>En este contexto, surge la herramienta HexaRCi como un instrumento innovador que permite a las organizaciones navegar de manera sistemática y racional a través de su modelo de negocio. HexaRCi ofrece a los usuarios una perspectiva integral para recorrer los elementos críticos de la organización, facilitando la elaboración de estrategias que aproximan a la empresa hacia su esquema de funcionamiento ideal.<br><br>Mediante un enfoque metódico, esta herramienta proporciona un marco de referencia para identificar, analizar y gestionar los riesgos empresariales, transformando lo que tradicionalmente se percibe como una amenaza en una oportunidad de mejora y crecimiento estratégico.";
        terceraPagina.appendChild(parrafo);

        contenido.appendChild(terceraPagina);




        // ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
        // ♦ Añadir la sexta pagina con un borde
        // ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
        const paginaHexa = crearPaginaConMarco();

        parrafo = document.createElement('p');
        parrafo.innerHTML = "El Modelo HexaRCi";
        parrafo.style.fontFamily = 'Helvetica, Arial, sans-serif';
        parrafo.style.fontSize = '16pt';
        parrafo.style.fontWeight = 'bold';
        parrafo.style.textAlign = 'center';
        parrafo.style.marginTop = '5mm';
        paginaHexa.appendChild(parrafo);

        parrafo = document.createElement('p');
        parrafo.style.fontFamily = 'Helvetica, Arial, sans-serif';
        parrafo.style.fontSize = '13pt';
        parrafo.style.lineHeight = '1.5';
        parrafo.innerHTML = "El Modelo HexaRCi está preparado para empresas que tengan una estructura de Directorio de tres o más directores. En consecuencia, no es aplicable a empresas con estructuras más pequeñas. Tampoco es aplicable a empresas específicamente reguladas como ser Bancos y Compañías de seguro.<br><br>Una versión también interactiva, Modelo HexaRCiS, para compañías más pequeñas, está en desarrollo, con un enfoque conceptual idéntico, pero adaptado a las características de este tipo de empresas.<br><br>Cada factor de los seis arriba indicados tiene una metodología plasmada en las 'Planillas de Autoevaluación'.<br><br>Existe una Planilla por cada factor evaluado. Así, existen seis Planillas: de Apetito de Riesgo; de Riesgos de Mercado; de Riesgos de Procesos; de Riesgos de Gobierno Corporativo; de Generación de Resultados y de Situación Financiera.<br><br>Cada Planilla presenta un número determinado de afirmaciones; a cada afirmación le corresponde un puntaje predeterminado; el puntaje representa el nivel de efectividad en el cumplimiento de la afirmación; el evaluador debe seleccionar, de acuerdo con su criterio, el puntaje que considera cumple la compañía. Cada Planilla, luego de ser completada por el evaluador concluye en un puntaje total que representa el porcentaje de cumplimiento respecto de un puntaje total posible del factor evaluado.";

        paginaHexa.appendChild(parrafo);

        contenido.appendChild(paginaHexa);


        // ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
        // ♦ Añadir la cuarta página (contenido) con un borde
        // ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
        const cuartaPagina = crearPaginaConMarco();

        parrafo = document.createElement('p');
        parrafo.innerHTML = "Aplicación del Modelo y Conclusiones";
        parrafo.style.fontFamily = 'Helvetica, Arial, sans-serif';
        parrafo.style.fontSize = '16pt';
        parrafo.style.fontWeight = 'bold';
        parrafo.style.textAlign = 'center';
        parrafo.style.marginTop = '5mm';
        cuartaPagina.appendChild(parrafo);

        parrafo2 = document.createElement('p');
        parrafo2.style.fontFamily = 'Helvetica, Arial, sans-serif';
        parrafo2.style.fontSize = '13pt';
        parrafo2.style.lineHeight = '1.5';
        parrafo2.style.fontStyle = 'normal'; // Agregar estilo itálico
        parrafo2.innerHTML = "De acuerdo con la información cargada por <strong><span class='company-name' style='font-size: 16px'>BDT Advisory </span></strong> y a los parámetros del Modelo HexaRCi, la Compañia <strong><span class='company-name' style='font-size: 16px'>BDT Advisory </span></strong> es una compañia calificada preliminarmente como tipo:"
        cuartaPagina.appendChild(parrafo2);

        const resultado = document.createElement('p');
        resultado.innerHTML = tipificacion;
        resultado.style.fontFamily = 'Helvetica, Arial, sans-serif';
        resultado.style.fontSize = '16pt';
        resultado.style.fontWeight = 'bold';
        resultado.style.textAlign = 'center';
        resultado.style.marginTop = '7mm';
        cuartaPagina.appendChild(resultado);

        parrafo = document.createElement('p');
        parrafo.style.fontFamily = 'Helvetica, Arial, sans-serif';
        parrafo.style.fontSize = '13pt';
        parrafo.style.lineHeight = '1.5';
        parrafo.innerHTML = 'BDT ADVISORY ' + textoTipificacion;
        cuartaPagina.appendChild(parrafo);

        contenido.appendChild(cuartaPagina);

        // ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
        // ♦ Añadir la quinta página dibuho hexagono
        // ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

        const quintaPagina = crearPaginaConMarco();


        parrafo = document.createElement('p');
        parrafo.style.fontFamily = 'Helvetica, Arial, sans-serif';
        parrafo.style.fontSize = '14pt';
        parrafo.style.lineHeight = '1.5';
        parrafo.innerHTML = "<strong><span class='company-name' style='font-size: 16px'>Representación gráfica</span></strong>";
        quintaPagina.appendChild(parrafo);

        function crearContenidoPDF() {

            // Crear canvas para el hexágono
            const hexagonoCanvas = document.createElement('canvas');
            hexagonoCanvas.id = 'hexagonoPDF';
            hexagonoCanvas.width = 700;
            hexagonoCanvas.height = 700;
            hexagonoCanvas.style.maxWidth = '100%';
            hexagonoCanvas.style.height = 'auto';

            // Contexto del canvas
            const ctx = hexagonoCanvas.getContext('2d');

            // Variables para el hexágono
            const var1 = 59.91, var2 = 89.50, var3 = 59.09, var4 = 72.64, var5 = 63.00, var6 = 41.36;
            const variablesHexagono = [var1, var2, var3, var4, var5, var6];

            const rotulosHexagono = [
                'Gobierno Corporativo',
                'Apetito Riesgo',
                'Riesgos Mercado',
                'Riesgos Procesos',
                'Situación Financiera',
                'Generación Resultados'
            ];

            const centerX = hexagonoCanvas.width / 2;
            const centerY = hexagonoCanvas.height / 2;
            const radioMax = 170;
            const radio90 = radioMax * 0.9;
            const radio70 = radioMax * 0.7;
            const radio50 = radioMax * 0.5;

            ctx.clearRect(0, 0, hexagonoCanvas.width, hexagonoCanvas.height);

            // Dibujar hexágonos de fondo
            function dibujarHexagonoFondo(radio, color, strokeColor) {
                ctx.beginPath();
                for (let i = 0; i < 6; i++) {
                    const angulo = (i * Math.PI) / 3;
                    const x = centerX + radio * Math.cos(angulo);
                    const y = centerY + radio * Math.sin(angulo);

                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                ctx.closePath();
                ctx.fillStyle = color;
                ctx.fill();
                ctx.strokeStyle = strokeColor;
                ctx.stroke();
            }

            // Dibujar hexágonos de fondo
            dibujarHexagonoFondo(radioMax, 'rgba(173, 216, 230, 0.7)', 'black');
            dibujarHexagonoFondo(radio90, 'rgba(0, 255, 0, 0.7)', 'green');
            dibujarHexagonoFondo(radio70, 'rgba(255, 255, 0, 0.7)', 'yellow');
            dibujarHexagonoFondo(radio50, 'rgba(255, 0, 0, 0.9)', 'red');

            // Dibujar líneas desde el centro
            ctx.beginPath();
            for (let i = 0; i < 6; i++) {
                const angulo = (i * Math.PI) / 3;
                const x = centerX + radioMax * Math.cos(angulo);
                const y = centerY + radioMax * Math.sin(angulo);

                ctx.moveTo(centerX, centerY);
                ctx.lineTo(x, y);
            }
            ctx.strokeStyle = 'gray';
            ctx.stroke();

            // Dibujar área de variables
            ctx.beginPath();
            for (let i = 0; i < 6; i++) {
                const angulo = (i * Math.PI) / 3;
                const porcentaje = variablesHexagono[i] / 100;
                const radio = radioMax * porcentaje;
                const x = centerX + radio * Math.cos(angulo);
                const y = centerY + radio * Math.sin(angulo);

                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.closePath();
            ctx.fillStyle = 'rgba(0, 150, 255, 0.7)';
            ctx.fill();
            ctx.strokeStyle = 'blue';
            ctx.stroke();

            // Agregar valores de variables
            ctx.font = '17px Arial, strong';
            ctx.fillStyle = 'black';
            variablesHexagono.forEach((valor, i) => {
                const angulo = (i * Math.PI) / 3;
                const porcentaje = valor / 100;
                const radioTexto = radioMax * porcentaje * 0.9;
                const xTexto = centerX + radioTexto * Math.cos(angulo);
                const yTexto = centerY + radioTexto * Math.sin(angulo);
                ctx.fillText(`${valor}%`, xTexto - 15, yTexto + 5);
            });

            // Agregar rótulos
            ctx.font = '15px Arial, strong';
            ctx.fillStyle = 'black';
            rotulosHexagono.forEach((rotulo, i) => {
                const angulo = (i * Math.PI) / 3;
                const xRotulo = centerX + (radioMax + 20) * Math.cos(angulo);
                const yRotulo = centerY + (radioMax + 20) * Math.sin(angulo);
                const palabras = rotulo.split(' ');

                if (i === 3) {
                    ctx.fillText(palabras[0], xRotulo - 35, yRotulo - 5);
                    ctx.fillText(palabras[1], xRotulo - 35, yRotulo + 14);
                } else {
                    ctx.fillText(palabras[0], xRotulo - 18, yRotulo - 5);
                    ctx.fillText(palabras[1], xRotulo - 18, yRotulo + 14);
                }
            });

            // Contenedor para la imagen del canvas
            const canvasContainer = document.createElement('div');
            canvasContainer.style.width = '100%';
            canvasContainer.style.display = 'flex';
            canvasContainer.style.justifyContent = 'center';
            canvasContainer.style.marginTop = '20px';

            // Convertir canvas a imagen
            const imagenHexagono = document.createElement('img');
            imagenHexagono.src = hexagonoCanvas.toDataURL('image/png');
            imagenHexagono.style.maxWidth = '100%';
            imagenHexagono.style.height = 'auto';

            canvasContainer.appendChild(imagenHexagono);
            quintaPagina.appendChild(canvasContainer);
            // contenido.appendChild(quintaPagina);

            console.log("llego hasta aca")
            return contenido;
        }

        crearContenidoPDF();

        parrafo = document.createElement('p');
        parrafo.style.fontFamily = 'Helvetica, Arial, sans-serif';
        parrafo.style.fontSize = '13pt';
        parrafo.style.lineHeight = '1.5';
        parrafo.innerHTML = "Si cada factor alcanzare el 100% se conformaría un 'Hexágono perfecto' y de esa manera <strong><span class='company-name' style='font-size: 16px'></span></strong> se constituiría en una empresa competitiva de acuerdo con el Modelo HexaRCi.<br><br>Consecuentemente se debe construir una estrategia de mejora adaptada a las características y particularidades de <strong><span class='company-name' style='font-size: 16px'>BDT ADVISORY</span></strong>, de forma que mediante un proceso de mejora continua en el manejo de los riesgos se la prepare para ir alcanzando el 'Hexágono Perfecto'";
        quintaPagina.appendChild(parrafo);

        contenido.appendChild(quintaPagina);

        // ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
        // ♦ Añadir la sexta pagina presenta mejoras
        // ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
        const sextaPagina = crearPaginaConMarco();

        parrafo = document.createElement('p');
        parrafo.innerHTML = "Recomendaciones.  Oportunidades de mejora";
        parrafo.style.fontFamily = 'Helvetica, Arial, sans-serif';
        parrafo.style.fontSize = '16pt';
        parrafo.style.fontWeight = 'bold';
        parrafo.style.textAlign = 'center';
        parrafo.style.marginTop = '5mm';
        sextaPagina.appendChild(parrafo);

        parrafo = document.createElement('p');
        parrafo.style.fontFamily = 'Helvetica, Arial, sans-serif';
        parrafo.style.fontSize = '13pt';
        parrafo.style.lineHeight = '1.5';
        parrafo.innerHTML = "El análisis realizado a través del Modelo HEXARCi mediante la valoración otorgada a cada situación, ha permitido identificar diversas oportunidades de mejora en la gestión de riesgos. El adecuado tratamiento de estas oportunidades puede fortalecer sus procesos y estrategias para una gestión más eficiente y proactiva.<br><br>Al implementar medidas correctivas o de optimización, se logrará reducir la brecha entre la situación actual de la organización y el estado ideal, mejorando su capacidad de respuesta ante posibles riesgos y fortaleciendo su sostenibilidad a largo plazo.<br><br>Los aspectos a mejorar más significativos en cada factor de riesgo:<br><br>♦ Manejo de los Riesgos de Gobierno Corporativo (MRG);<br><br> Manejo de los Riesgos del Apetito de Riesgo (MAR);<br><br> Manejo de los Riesgos de Mercado (MRM) y<br><br> Manejo de los Riesgos de los Procesos<br><br>se exponen a continuación:";
        sextaPagina.appendChild(parrafo);

        contenido.appendChild(sextaPagina);


        // ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
        // ♦ Añadir paginas con mejoras
        // ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

        capitulos = await leeCapitulos();
        console.log(capitulos)

        for (const capitulo of capitulos) {
            if (capitulo.letra == "E" || capitulo.letra == "F") {
                continue;
            }

            matrizPreguntas = await recuperarPreguntas(capitulo.letra);

            const mejorasPagina = crearPaginaConMarco();

            parrafo = document.createElement('p');
            parrafo.style.fontFamily = 'Helvetica, Arial, sans-serif';
            parrafo.style.fontSize = '16pt';
            parrafo.style.fontWeight = 'bold';
            parrafo.style.textAlign = 'center';
            parrafo.style.marginTop = '5mm';

            // Crear el título del capítulo ::::::::::::::::::::::::::.
            // let titulo = document.createElement("h3");
            parrafo.innerHTML = `Factor: ${capitulo.nombre}`;
            // contenedor.appendChild(titulo);
            mejorasPagina.appendChild(parrafo);

            // Busca las respuestas de ese capítulo
            const data = await buscaRespuesta(CUIT, capitulo.letra);
            console.log(`cuit ${CUIT}, capitulo ${capitulo.letra}`)
            const respuestas = data.respuestas || []; // Si no hay respuestas, asigna un array vacío
            console.log(respuestas)

            // Crear el encabezado (seccion):::::::::::::::::::::::::::
            for (const respuesta of respuestas) {
                if (respuesta.porcentaje > max) { // descarta capitulo
                    continue;
                }

                const existeTipo = matrizPreguntas.some(
                    (p) =>
                        p.Capitulo == respuesta.capitulo &&
                        p.Seccion == respuesta.seccion &&
                        (p.tipo == 1 || p.tipo == 52)
                );

                if (!existeTipo) { // No hay 1 o 52 en matrizPreguntas para seccion
                    continue; // Salta a la siguiente iteración del bucle
                }

                const indice = respuesta.seccion;
                const descripcion = await obtenerNombreSeccion(
                    indice,
                    idioma,
                    capitulo.letra
                );

                const descripcionElemento = document.createElement('div');
                descripcionElemento.style.fontSize = "15px";
                if (capitulo.letra == "A") {
                    descripcionElemento.style.backgroundColor = "#FAF0E6";
                }
                if (capitulo.letra == "B") {
                    descripcionElemento.style.backgroundColor = "#F0E68C";
                }
                if (capitulo.letra == "C") {
                    descripcionElemento.style.backgroundColor = "#D3D3D3";
                }
                if (capitulo.letra == "D") {
                    descripcionElemento.style.backgroundColor = "#F0F8FF";
                }
                descripcionElemento.innerHTML = "[ " + respuesta.porcentaje + " % ]  -  Sección: " + respuesta.seccion + ". " + descripcion;
                mejorasPagina.appendChild(descripcionElemento);


                // contenido.appendChild(mejorasPagina);


                // Crear el cuerpo de la tabla::::::::::::::::::::::::::::::
                let info = respuesta.seccion;
                let preguntasSeccion = matrizPreguntas.filter( //  Filtra las preguntas para la seccion seleccionada
                    (pregunta) => pregunta.Seccion == info
                );

                // itera por todas las preguntas filtradas
                for (const pregunta of preguntasSeccion) {
                    let filaSeccion = document.createElement("tr");
                    filaSeccion.classList.add("situacion2");

                    let filaRespuesta = document.createElement("div");
                    filaRespuesta.classList.add("situacion2");

                    let celdaNumero = document.createElement("div");
                    celdaNumero.style.width = "5px"; // Define el ancho en píxeles
                    celdaNumero.textContent = pregunta.Numero;
                    filaRespuesta.appendChild(celdaNumero);

                    let consigna = document.createElement("div");
                    consigna.style.width = "300px"; // Define el ancho en píxeles
                    consigna.textContent = pregunta.Descrip;
                    consigna.style.fontSize = "16px";
                    filaRespuesta.appendChild(consigna);

                    poneRespuesta(respuesta, pregunta).then((texto) => {
                        if (pregunta.tipo == "52") {
                            if (texto == "No efectivo" || texto == "Poco efectivo") {
                                mejorasPagina.appendChild(filaRespuesta);
                            }
                        };

                        if (pregunta.tipo == "1") {
                            if (texto == "NO") {
                                mejorasPagina.appendChild(filaRespuesta);
                            }
                        };
                    })
                }

                contenido.appendChild(mejorasPagina);
            }
        }

        // ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
        // ♦ ultima pagina
        // ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
        const ultimaPagina = crearPaginaConMarco('Autoevaluación', '890');

        const tituloUltima = document.createElement('p');
        tituloUltima.innerHTML = "Ejemplo de borde";
        tituloUltima.style.fontFamily = 'Helvetica, Arial, sans-serif';
        tituloUltima.style.fontSize = '16pt';
        tituloUltima.style.fontWeight = 'bold';
        tituloUltima.style.textAlign = 'center';
        tituloUltima.style.marginTop = '5mm';
        ultimaPagina.appendChild(tituloUltima);

        parrafo = document.createElement('p');
        parrafo.style.fontFamily = 'Helvetica, Arial, sans-serif';
        parrafo.style.fontSize = '13pt';
        parrafo.style.lineHeight = '1.5';
        parrafo.innerHTML = "Solo para el borde.";
        ultimaPagina.appendChild(parrafo);

        contenido.appendChild(ultimaPagina);



        // Generar PDF directamente
        html2pdf().from(contenido).set(opciones).save()
            .catch(error => {
                console.error("Error generando PDF:", error);
            });
    }


    function crearPaginaConMarco(textoLateral, numeroPagina) {
        const pagina = document.createElement('div');
        pagina.style.padding = '10mm';
        pagina.style.margin = '10mm';
        pagina.style.border = '2px solid #000';
        pagina.style.boxShadow = '0 0 10mm rgba(0,0,0,0.1)'; // Sombra suave
        pagina.style.minHeight = '240mm';
        pagina.style.borderRadius = '5mm';
        pagina.style.position = 'relative'; // Para posicionar elementos internos
        pagina.style.pageBreakAfter = 'always'; // Salto de página después

        // Si se proporciona texto lateral
        if (textoLateral) {
            const textoLateralElemento = document.createElement('div');
            textoLateralElemento.textContent = textoLateral;
            textoLateralElemento.style.position = 'absolute';
            textoLateralElemento.style.left = '85%'; // centrado horizontalmente
            textoLateralElemento.style.top = '-3%'; // centrado verticalmente
            textoLateralElemento.style.transform = 'translateX(-50%, -50%)';
            textoLateralElemento.style.transformOrigin = 'left center';
            // textoLateralElemento.style.bottom = '-200px'; // Ajusta este valor según necesites
            textoLateralElemento.style.whiteSpace = 'nowrap';
            textoLateralElemento.style.fontFamily = 'Helvetica, Arial, sans-serif';
            textoLateralElemento.style.fontSize = '10pt';
            textoLateralElemento.style.color = '#666'; // Color gris para mayor visibilidad
            // textoLateralElemento.style.opacity = '0.8'; // Semi-transparente

            pagina.appendChild(textoLateralElemento);
        }

        // Número de página
        if (numeroPagina !== undefined) {
            const paginaNumero = document.createElement('div');
            paginaNumero.textContent = `Página ${numeroPagina}`;
            paginaNumero.style.position = 'absolute';
            paginaNumero.style.left = '50%';
            paginaNumero.style.transform = 'translateX(-50%)';
            paginaNumero.style.bottom = '-20px'; // Ajusta según necesites
            paginaNumero.style.fontFamily = 'Helvetica, Arial, sans-serif';
            paginaNumero.style.fontSize = '10pt';
            paginaNumero.style.color = '#666';

            pagina.appendChild(paginaNumero);
        }
        return pagina;
    }

    /* ----------------------------------------- */
    /*           lee Capitulos
    /* ----------------------------------------- */
    async function leeCapitulos() {
        try {
            const respuesta = await fetch(`/capitulos?idioma=${idioma}`);
            if (respuesta.ok) {
                const capitulos = await respuesta.json();
                return capitulos;
            } else {
                console.error("Error al obtener los datos");
            }
        } catch (error) {
            console.error("Error al realizar la solicitud:", error);
        }
        return false;
    }

    // -----------------------------------------
    //   recuperarPreguntas          
    /* ----------------------------------------- */
    async function recuperarPreguntas(capitulo) {
        try {
            let url = "/preguntas";
            if (capitulo !== null) {
                url += `?capitulo=${encodeURIComponent(capitulo)}`;
            }

            const response = await fetch(url);
            if (response.ok) {
                const result = await response.json(); // Procesa la respuesta como JSON
                // console.log("termino lectura preguntas");
                return Array.isArray(result) ? result : []; // Asegura devolver un arreglo
            } else {
                console.error("Error al obtener las preguntas:", response.statusText);
                return [];
            }
        } catch (error) {
            console.error("Error al realizar la solicitud:", error);
            return [];
        }
    }

    /* -----------------------------------------
    //     buscaRespuesta    
    /* ----------------------------------------- */
    async function buscaRespuesta(CUIT, capitulo) {
        try {
            const response = await fetch(
                `/busca-respuesta-capitulo-ordenado?CUIT=${CUIT}&capitulo=${capitulo}`
            );
            if (!response.ok) {
                throw new Error("Respuesta no OK de buscaRespuesta");
            }

            const resultado = await response.json();
            return { exists: resultado.exists, respuestas: resultado.records || [] };
        } catch (error) {
            console.error("Error al realizar la solicitud en buscaRespuesta:", error);
            return { exists: false, respuestas: [] };
        }
    }

    /* -----------------------------------------
    obtenerNombreSeccion
    /* ----------------------------------------- */
    async function obtenerNombreSeccion(indice, idioma, capitulo) {
        try {
            const response = await fetch(
                `/secciones?indice=${indice}&idioma=${idioma}&capitulo=${capitulo}`
            );
            if (!response.ok) {
                throw new Error(`Error en la solicitud: ${response.statusText}`);
            }

            const data = await response.json();
            if (data.length > 0) {
                return data[0].descripcion;
            } else {
                return "Descripción no disponible";
            }
        } catch (error) {
            console.error(
                `para leer indice ${indice}, idioma ${idioma}, capitulo ${capitulo}`
            );
            console.error("Error al obtener la descripción:", error);
            return "Descripción no disponible";
        }
    }


    /* -----------------------------------------
    poneRespuesta
    /* ----------------------------------------- */
    async function poneRespuesta(respuesta, pregunta) {
        // recupera la respuesta segun el numero de pregunta....;
        const registroRespuestasSeccion = respuesta; //es el arreglo de respuestas para todas las preguntas de la seccion)
        let arrayRespuestas = registroRespuestasSeccion.respuesta;

        valorRespuesta = arrayRespuestas[pregunta.Numero - 1]; // resta 1 por la posición 0

        // segun el tipo de respuesta (en pregunta.tipo) se convierte para mostrar
        // tipo 1:  1: si,  2: no
        if (pregunta.tipo == 1) {
            if (valorRespuesta == 1) {
                return "SI";
            } else {
                return "NO";
            }
        }

        if (pregunta.tipo == 3) {
            return valorRespuesta;
        }

        if (pregunta.tipo == 51) {
            const registroTextoRespuestas = textoRespuestas.find(
                (item) => item.pregunta == pregunta.tipo
            );
            return registroTextoRespuestas.textos[valorRespuesta - 1];
        }

        if (pregunta.tipo > 50) {
            try {
                const registroTextoRespuestas = textoRespuestas.find(
                    (registro) => registro.pregunta === pregunta.tipo
                );
                if (!registroTextoRespuestas) {
                    console.error(
                        `No se encontró un registro con pregunta igual a ${pregunta.tipo}`
                    );
                }
                valorRespuesta = arrayRespuestas[pregunta.Numero - 1]; // resta 1 por la posición 0
                if (valorRespuesta == "9") {
                    return "No aplica";
                } else {
                    const texto = registroTextoRespuestas.textos[valorRespuesta - 1];
                    return texto;
                }
            } catch (error) {
                console.error("Error procesando bloque para pregunta.tipo > 50:", error);
            }
        }

        if (pregunta.tipo > 40 && pregunta.tipo < 50) {
            console.log(
                `\n Pregunta a procesar ${pregunta.Numero} y tipo ${pregunta.tipo} \n`
            );
            let indicesCheck = 0;
            const registroTextoCheck = textoCheck.find(
                (item) => item.pregunta == pregunta.tipo
            );
            if (!registroTextoCheck) {
                console.log(
                    "No se encontró ninguna fila con la pregunta:",
                    pregunta.tipo
                );
                return;
            }
            valorRespuesta = arrayRespuestas[pregunta.Numero - 1]; // resta 1 por la posición 0
            const valoresTextoCheck = registroTextoCheck.textos;
            // console.log(`registro Respuestas seccion  ${registroRespuestasSeccion.respuesta}`);
            if (pregunta.tipo == 42 || pregunta.tipo == 43) {
                arrayRespuestas = registroRespuestasSeccion.respuesta;
            } else {
                arrayRespuestas = registroRespuestasSeccion.respuesta[6];
            }
            // console.log(`array rsepuestas  ${arrayRespuestas}`)
            let conjunto = "";
            arrayRespuestas.forEach((indice, i) => {
                const texto = valoresTextoCheck[indice - 1]; // Obtener el texto correspondiente al índice
                if (i > 0) {
                    conjunto += ", "; // Agregar una coma y un espacio antes de cada texto (excepto el primero)
                }
                conjunto += texto;
            });
            return conjunto;
        }
    }


    /* -----------------------------------------
    leeTextoCheck          
    /* ----------------------------------------- */
    async function leeTextoCheck() {
        try {
            const response = await fetch("/textocheck");
            if (response.ok) {
                const result = await response.json();
                return Array.isArray(result) ? result : []; // Asegura devolver un arreglo
            } else {
                console.error("Error al obtener las preguntas:", response.statusText);
                return [];
            }
        } catch (error) {
            console.error("Error al realizar la solicitud:", error);
            return [];
        }
    }

    /* -----------------------------------------
    leeTextoRespuestas         
    /* ----------------------------------------- */
    async function leeTextoRespuestas() {
        try {
            const response = await fetch("/textorespuestas");
            if (response.ok) {
                const result = await response.json();
                // console.log("Datos recibidos de /textorespuestas:", result); // Verifica la estructura aquí
                return Array.isArray(result) ? result : []; // Asegura devolver un arreglo
            } else {
                console.error("Error al obtener las preguntas:", response.statusText);
                return [];
            }
        } catch (error) {
            console.error("Error al realizar la solicitud:", error);
            return [];
        }
    }

</script>

</html>