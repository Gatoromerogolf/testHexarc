<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Evaluación de riesgos</title>
        <script src="https://cdn.jsdelivr.net/npm/gaugeJS/dist/gauge.min.js"></script>
        <link href="../estilos/estiloEncuestas.css" rel="stylesheet">
        <!-- <link href="css/st-gobCorpo.css" rel="stylesheet"> -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

        <style>
            table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 1em;
            }
            th, td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: center;
            }
            th {
                background-color: #f4f4f4;
            }
            .question-cell {
                text-align: left;
            }
            .option-input {
                margin-right: 5px;
            }
        </style>
    </head>
    <body>
        <div class="survey-container">
          <section class="main">
            <section class="gobCorpo">
              <div class="header-container">
                <div class="header-center">
                  <div id="nombreEmpresa" class="company-name"></div>
                  <div id="nombreUsuario" class="user-name"></div>
                </div>
                <div class="nav-iconsxx">
                  <h4> A - Manejo de los Riesgos de Procesos</h4>
                </div>
                <div class="nav-iconsxx">
                  <h5> Autoevaluación</h5>
                </div>
              </div>
              <hr>
      
            <!-- <form id="formulario"> -->
                <form id="surveyForm">
      
              <div class="center-container">
                <h4 class="tituloSeccion"><a href="Menu-D.html">I - Selección de cartera de productos</a></h4>
              </div>
      
              <div class="salida">
                <p>Seleccione la opción que corresponda a su organización.</p>
                <button type="button" id="boton-salir">Salir</button>
              </div>
      
              <div id="overlay">
                <div id="ventanaSalida">
                  <!-- <div class="confirm-modal" id="confirm-modal">-->
                  <div class="confirm-box">
                    <p>La información registrada hasta el momento quedará almacenada. <br> Si sale de la aplicación, podrá
                      completar posteriormente los items faltantes.
                      <br>
                    </p>Confirme si desea 'Salir' de la aplicación o 'Continuar' con el registro de datos.</p>
                    <button id="confirm-yes">Salir</button>
                    <button id="confirm-no">Continuar</button><br>
                  </div>
                </div>
              </div>

    <!-- <form id="surveyForm"> -->
        <table>
            <thead>
                <tr>
                    <th>Propuesta</th>
                    <th>No efectivo</th>
                    <th>Poco efectivo</th>
                    <th>Efectivo</th>
                    <th>Muy efectivo</th>
                </tr>
            </thead>
            <tbody id="questionsTableBody">
                <!-- Las preguntas se agregarán aquí dinámicamente -->
            </tbody>
        </table>
        <button type="button" onclick="submitForm()">Enviar</button>
        <button type="button" onclick="resetForm()">Borrar Respuestas</button>
    </form>

    <script>
        // Función para construir la tabla de preguntas
        function buildForm(questions) {
            const tableBody = document.getElementById('questionsTableBody');
            questions.forEach(question => {
                const row = document.createElement('tr');
                
                // Columna de la pregunta
                const questionCell = document.createElement('td');
                questionCell.classList.add('question-cell');
                questionCell.textContent = question.Descrip;
                row.appendChild(questionCell);
                
                // Opciones
                for (let i = 1; i <= 4; i++) {
                    const optionCell = document.createElement('td');
                    
                    const optionInput = document.createElement('input');
                    optionInput.type = 'radio';
                    optionInput.name = `question_${question.id}`;
                    optionInput.value = i;
                    optionInput.classList.add('option-input');
                    optionInput.id = `q${question.id}_o${i}`;
                    
                    // Añadir el input directamente en la celda
                    optionCell.appendChild(optionInput);
                    
                    // Añadir el texto de la opción en la celda
                    // const optionText = document.createTextNode(`Opción ${i}`);
                    // optionCell.appendChild(optionText);
                    
                    row.appendChild(optionCell);
                }
                
                tableBody.appendChild(row);
            });
        }

        // Función para obtener las preguntas del servidor
        function loadQuestions() {
            let url = '/preguntas';

            // Agregar parámetros a la URL si existen
            let capitulo = "D";
            let seccion = 2;
            if (capitulo || seccion) {
                url += `?${capitulo ? `capitulo=${encodeURIComponent(capitulo)}` : ''}${capitulo && seccion ? '&' : ''}${seccion ? `seccion=${encodeURIComponent(seccion)}` : ''}`;
            }

            fetch(url)
                .then(response => response.json())
                .then(data => buildForm(data))
                .catch(error => console.error('Error al cargar las preguntas:', error));
        }

        // Cargar las preguntas cuando la página se cargue
        document.addEventListener('DOMContentLoaded', loadQuestions);


  // Función para manejar el envío del formulario
      function submitForm() {
        const questions = document.querySelectorAll('tbody tr');
        const responses = [];
        let allAnswered = true;
        let unansweredQuestions = [];

        questions.forEach((row, index) => {
            const questionId = row.querySelector('input[type="radio"]').name.split('_')[1]; // Obtener el ID de la pregunta desde el name
            const selectedOption = row.querySelector(`input[name="question_${questionId}"]:checked`);

            if (selectedOption) {
                responses.push(selectedOption.value);
            } else {
              unansweredQuestions.push(index + 1); // Agregar el número de la pregunta que falta responder
            }
        });

        if (unansweredQuestions.length > 0) {
        alert(`Por favor, selecciona una opción para las siguientes preguntas: ${unansweredQuestions.join(', ')}`);
        } else {
            console.log('Respuestas:', responses);
            // Aquí puedes enviar 'responses' al servidor o procesarlo como desees
        }


    //     if (unansweredQuestions.length > 0) {
    //     alert(`Por favor, selecciona una opción para las siguientes preguntas: ${unansweredQuestions.join(', ')}`);
    // } else {
    //     // Enviar las respuestas al servidor
    //     fetch('/guardarRespuestas', {
    //         method: 'POST',
    //         headers: {
    //             'Content-Type': 'application/json'
    //         },
    //         body: JSON.stringify(responses)
    //     }).then(response => {
    //         if (response.ok) {
    //             // Redirigir a otra página después de guardar las respuestas
    //             window.location.href = 'index.html';
    //         } else {
    //             // Manejar el error si la respuesta del servidor no es exitosa
    //             alert('Hubo un problema al guardar las respuestas. Por favor, intenta nuevamente.');
    //         }
    //     }).catch(error => {
    //         console.error('Error al enviar las respuestas:', error);
    //         alert('Hubo un problema al conectar con el servidor. Por favor, intenta nuevamente.');
    //     });
    // }
        // if (allAnswered) {
        //     console.log('Respuestas:', responses);
            // Aquí puedes enviar 'responses' al servidor o procesarlo como desees
            // fetch('/guardarRespuestas', {
            //     method: 'POST',
            //     headers: {
            //         'Content-Type': 'application/json'
            //     },
            //     body: JSON.stringify(responses)
            // }).then(response => {
            //     // Manejar la respuesta del servidor
            // });
        // }
    }

    function resetForm() {
        location.reload(); // Recarga la página para restablecer el formulario
    }
    </script>
</body>
</html>

<!-- 

Asignación de name

optionInput.name = `question_${question.id}`;

name: El atributo name es fundamental en los formularios HTML, ya que agrupa los inputs de radio de una misma pregunta. En este caso, el name de cada input de radio es question_ seguido del id de la pregunta (question.id). Esto asegura que todos los radios que pertenecen a la misma pregunta tengan el mismo name, lo que permite que solo una opción pueda ser seleccionada por pregunta.

Asignación de id

optionInput.id = `q${question.id}_o${i}`;

id: El id es un identificador único para cada input de radio. En este caso, se compone de q seguido del id de la pregunta y _o seguido del número de la opción (i). Esto garantiza que cada input de radio tenga un identificador único en el documento.

Validación y Envío de Respuestas

Al momento de validar y procesar las respuestas, tu código anterior usa el name de los inputs para identificar la respuesta seleccionada. Dado que todos los inputs de una misma pregunta comparten el mismo name, pero tienen diferentes valores (1 a 4), la lógica de validación y procesamiento funcionará correctamente, siempre que se estén recorriendo y evaluando las preguntas correctamente.

Consideraciones

Si cada pregunta tiene un id único (y question.id es ese id), la asignación de nombres debería funcionar sin problemas. Asegúrate de que:

question.id es único y consistente en toda la encuesta.

Los inputs de radio se generan con el mismo name para cada pregunta pero con diferentes value.
Con esta estructura, tu código debería estar agrupando correctamente las opciones de cada pregunta, permitiendo seleccionar solo una opción por pregunta, y el procesamiento de las respuestas debería funcionar como se espera. -->