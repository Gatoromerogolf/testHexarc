<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluación de riesgos</title>
    <!-- <link href="../estilos/estiloMenuGeneral.css" rel="stylesheet"> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

</head>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link
    href="https://fonts.googleapis.com/css2?family=Abel&family=Barlow+Condensed:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Courgette&family=Gupter:wght@400;500;700&family=PT+Sans+Narrow:wght@400;700&family=Roboto+Condensed:ital,wght@0,100..900;1,100..900&family=Roboto+Serif:ital,opsz,wght@0,8..144,100..900;1,8..144,100..900&display=swap"
    rel="stylesheet">


<style>
    @import url('https://fonts.googleapis.com/css?family=Muli&display=swap');
    @import url('https://fonts.googleapis.com/css?family=Open+Sans:400,500&display=swap');

    * {
        box-sizing: border-box;
    }


    body.financiero {
        background: url('/estilos/background%20financiero.jpg') no-repeat center center fixed;
        background-size: cover;
        margin: 0;
        padding: 0;
        background-repeat: no-repeat;
        height: 100%;
    }

    select,
    option {
        font-family: 'Open Sans', sans-serif;
        font-size: 14px;
    }

    .survey-container-presentacion {
        max-width: 900px;
        margin: 80px auto;
        padding: 40px;
        background-color: rgba(255, 255, 255, 0.95);
        /* Fondo blanco con opacidad */
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        border-radius: 8px;

        font-family: 'Abel', sans-serif;
        font-size: 18px;
        font-weight: 500;
        margin-top: 0x;
    }

    /* formulario fondo blanco */
    .container {
        background-color: #fff;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        overflow: hidden;
        width: 900px;
        max-width: 100%;
    }

    /*  titulo debajo de Crear cuenta */
    .header {
        border-bottom: 10px solid #f0f0f0;
        background-color: #f7f7f7;
        padding: 20px 40px;
    }

    .header h2 {
        margin: 0;
    }

    .form {
        padding: 30px 40px;
        /* hacia arrriba y a los costados */
    }

    .form-group {
        display: flex;
        gap: 20px;
        /* Espacio entre los campos */
    }

    .form-control {
        margin-bottom: 10px;
        padding-bottom: 20px;
        position: relative;

        flex: 1;
        /* Que cada campo ocupe el mismo espacio */
        display: flex;
        flex-direction: column;
    }


    .form-control label {
        display: inline-block;
        margin-bottom: 5px;
    }

    /* campos del formulario */
    .form-control input {
        border: 2px solid #f0f0f0;
        border-radius: 4px;
        display: block;
        font-family: inherit;
        font-size: 14px;
        padding: 10px;
        width: 100%;
    }

    .form-control input:focus {
        outline: 0;
        border-color: #777;
    }

    .form-control.success input {
        border-color: #2ecc71;
    }

    .form-control.error input {
        border-color: #e74c3c;
    }

    .form-control i {
        visibility: hidden;
        position: absolute;
        top: 40px;
        right: 10px;
    }

    .form-control.success i.fa-check-circle {
        color: #2ecc71;
        visibility: visible;
    }

    .form-control.error i.fa-exclamation-circle {
        color: #e74c3c;
        visibility: visible;
    }

    .form-control small {
        color: #e74c3c;
        position: absolute;
        bottom: 0;
        left: 0;
        visibility: hidden;
    }

    .form-control.error small {
        visibility: visible;
    }

    .form button {
        background-color: #8e44ad;
        border: 2px solid #8e44ad;
        border-radius: 4px;
        color: #fff;
        display: block;
        font-family: inherit;
        font-size: 16px;
        padding: 10px;
        margin-top: 20px;
        width: 100%;
    }

    .check {
        margin-left: 8px;
        /* Ajusta el espacio según necesites */
    }

    .password-container {
        position: relative;
        display: flex;
        align-items: center;
        width: 100%;
    }

    .password-container input {
        width: 100%;
        padding-right: 40px;
        /* Espacio para el icono */
    }

    .toggle-password {
        position: absolute;
        right: 10px;
        cursor: pointer;
        color: #666;
    }

    .toggle-password:hover {
        color: #333;
    }

    .password-container .toggle-password {
        position: absolute;
        right: 10px;
        cursor: pointer;
        font-size: 18px;
        color: #666;
    }

    input[type="checkbox"] {
        margin-left: -20px;
        /* Ajusta según necesites */
    }

    h1,
    h2,
    h3,
    h4 {
        text-align: center;
        color: #333333;
    }

    input:-webkit-autofill {
        background-color: white !important;
        box-shadow: 0 0 0px 1000px white inset !important;
    }

    fieldset {
        border: 3px solid #4CAF50;
        /* Borde más grueso */
        border-radius: 8px;
        /* Bordes redondeados */
        padding: 10px;
        /* Espaciado interno */
        margin-bottom: 20px;
        /* Espacio entre fieldsets */
    }

    textarea {
        border: 1px solid #dad9d9;
        /* Borde más grueso */
        border-radius: 6px;
        /* Bordes redondeados */
        padding: 10px;
        /* Espaciado interno */
        margin-bottom: 20px;
        /* Espacio entre fieldsets */
    }
</style>

<body class="financiero">
    <div class="survey-container-presentacion" style="max-width: 900px;">
        <div class="container">
            <div class="header">
                <!-- <div class="header-center">
                    <div id="nombreEmpresa" class="company-name"></div>
                    <div id="nombreUsuario" class="user-name"></div>
                </div> -->
                <p style="text-align: center;">Bienvenido <strong><span class="nombreEmpresa"
                            style="font-size: 22px"></span></strong></p>
                <h3>Crear cuenta</h3>
            </div>
            <form id="form" class="form">
                <fieldset>
                    <legend style="font-size: 20px; font-weight: 650">Datos del usuario.</legend>
                    <div class="form-group">
                        <div class="form-control">
                            <label for="nombreUsuario">Nombre</label>
                            <input type="text" id="nombreUsuario" />
                            <i class="fas fa-check-circle"></i>
                            <i class="fas fa-exclamation-circle"></i>
                            <small>Error message</small>
                        </div>
                        <div class="form-control">
                            <label for="apellidoUsuario">Apellido</label>
                            <input type="text" id="apellidoUsuario">
                            <i class="fas fa-check-circle"></i>
                            <i class="fas fa-exclamation-circle"></i>
                            <small>Error message</small>
                        </div>
                    </div>
                    <div class="form-control">
                        <label for="email">Correo electrónico</label>
                        <input type="email" id="email">
                        <i class="fas fa-check-circle"></i>
                        <i class="fas fa-exclamation-circle"></i>
                        <small>Error message</small>
                    </div>
                    <div class="form-group">
                        <div class="form-control">
                            <label for="password">Definir nueva clave</label>
                            <input type="password" id="password" autocomplete="new-password" minlength="4" required/>
                            <i class="fas fa-check-circle"></i>
                            <i class="fas fa-exclamation-circle"></i>
                            <small>Error message</small>
                        </div>
                        <div class="form-control">
                            <label for="password2">Repetir nueva clave</label>
                            <input type="password" id="password2" autocomplete="new-password" />
                            <i class="fas fa-check-circle"></i>
                            <i class="fas fa-exclamation-circle"></i>
                            <small>Error message</small>
                        </div>
                    </div>
                </fieldset>

                <fieldset>
                    <legend style="font-size: 20px; font-weight: 650">Datos de la Empresa.</legend>
                    <div class="form-control">
                        <label for="nombreEmpresa">Nombre</label>
                        <span class="nombreEmpresa" style="font-size: 20px; font-weight: 650"></span>
                        <i class="fas fa-check-circle"></i>
                        <i class="fas fa-exclamation-circle"></i>
                        <small>Error message</small>
                    </div>
                    <div class="form-control">
                        <label for="actividad">Descripción de la Actividad</label>
                        <!-- <textarea rows="4"  id="actividad"></textarea> -->
                        <input type="text" id="actividad">
                        <i class="fas fa-check-circle"></i>
                        <i class="fas fa-exclamation-circle"></i>
                        <small>Error message</small>
                    </div>
                </fieldset>


                <fieldset>
                    <legend style="font-size: 20px; font-weight: 650">Sobre el Directorio.</legend>
                    <div class="form-control">
                        <label for="calDirector">¿La calidad de los Directores ha mejorado en los últimos tres
                            años y por qué?</label>
                        <textarea rows="2" id="calDirector"></textarea>
                        <i class="fas fa-check-circle"></i>
                        <i class="fas fa-exclamation-circle"></i>
                        <small>Error message</small>
                    </div>
                    <div class="form-control">
                        <label for="calDirectorio">¿La calidad del Directorio ha mejorado en los últimos tres años y
                            por qué?</label>
                        <textarea rows="2" id="calDirectorio"></textarea>
                        <i class="fas fa-check-circle"></i>
                        <i class="fas fa-exclamation-circle"></i>
                        <small>Error message</small>
                    </div>
                </fieldset>


                <fieldset>
                    <legend style="font-size: 20px; font-weight: 650">Advisory Board.</legend>
                    <div class="form-group">
                        <div class="form-control">
                            <label for="advisory">Si existe, ¿hace cuanto tiempo funciona?</label>
                            <textarea rows="1" id="advisory"></textarea>
                            <i class="fas fa-check-circle"></i>
                            <i class="fas fa-exclamation-circle"></i>
                            <small>Error message</small>
                        </div>
                    </div>
                </fieldset>

                <fieldset>
                    <legend style="font-size: 20px; font-weight: 650">Situación Financiera y Resultados.</legend>
                    <div class="form-control">
                        <label for="finanEmpeorado">¿La situación financiera ha empeorado durante los últimos 3
                            años?</label>
                        <textarea rows="1" id="finanEmpeorado"></textarea>
                        <i class="fas fa-check-circle"></i>
                        <i class="fas fa-exclamation-circle"></i>
                        <small>Error message</small>
                    </div>
                    <div class="form-control">
                        <label for="finanTasas">¿Se ha tenido que recurrir a financiamiento no bancario a tasas
                            elevadas en los últimos tres años?</label>
                        <textarea rows="1" id="finanTasas"></textarea>
                        <i class="fas fa-check-circle"></i>
                        <i class="fas fa-exclamation-circle"></i>
                        <small>Error message</small>
                    </div>
                    <div class="form-control">
                        <label for="finanPercep">¿Se percibe que la situación descripta respecto del financiamiento
                            se mantendrá en el siguiente año?</label>
                        <textarea rows="1" id="finanPercep"></textarea>
                        <i class="fas fa-check-circle"></i>
                        <i class="fas fa-exclamation-circle"></i>
                        <small>Error message</small>
                    </div>
                    <div class="form-control">
                        <label for="resultados">¿Los resultados durante los últimos tres años han mejorado o
                            empeorado?</label>
                        <textarea rows="1" id="resultados"></textarea>
                        <i class="fas fa-check-circle"></i>
                        <i class="fas fa-exclamation-circle"></i>
                        <small>Error message</small>
                    </div>

                    <div class="form-control">
                        <label for="resultadosExtra">¿Los resultados durante alguno de los últimos tres años han sido
                            beneficiados por alguna circunstancia extraordinaria?</label>
                        <textarea rows="1" id="resultadosExtra"></textarea>
                        <i class="fas fa-check-circle"></i>
                        <i class="fas fa-exclamation-circle"></i>
                        <small>Error message</small>
                    </div>
                </fieldset>

                <fieldset>
                    <legend style="font-size: 20px; font-weight: 650">Estructura y procesos.</legend>
                    <div class="form-control">
                        <label for="subsidiarias">¿Tiene subsidiarias en el exterior y dónde?</label>
                        <textarea rows="1" id="subsidiarias"></textarea>
                        <i class="fas fa-check-circle"></i>
                        <i class="fas fa-exclamation-circle"></i>
                        <small>Error message</small>
                    </div>
                    <div class="form-control">
                        <label for="estrGerencial">¿La estructura gerencial se ha mantenido estable durante los tres
                            últimos años?</label>
                        <textarea rows="1" id="estrGerencial"></textarea>
                        <i class="fas fa-check-circle"></i>
                        <i class="fas fa-exclamation-circle"></i>
                        <small>Error message</small>
                    </div>

                    <div class="form-control">
                        <label for="formaRemota">¿La forma de trabajo durante los dos últimos años es predominantemente
                            remota?</label>
                        <textarea rows="1" id="formaRemota"></textarea>
                        <i class="fas fa-check-circle"></i>
                        <i class="fas fa-exclamation-circle"></i>
                        <small>Error message</small>
                    </div>

                    <div class="form-control">
                        <label for="cambioProcesos">¿Los procesos han mostrado cambios significativos en su diseño en
                            los dos últimos años?</label>
                        <textarea rows="1" id="cambioProcesos"></textarea>
                        <i class="fas fa-check-circle"></i>
                        <i class="fas fa-exclamation-circle"></i>
                        <small>Error message</small>
                    </div>

                    <div class="form-control">
                        <label for="tercerizaciones">¿Ha habido tercerizaciones significativas de procesos en los dos
                            últimos años?</label>
                        <textarea rows="1" id="tercerizaciones"></textarea>
                        <i class="fas fa-check-circle"></i>
                        <i class="fas fa-exclamation-circle"></i>
                        <small>Error message</small>
                    </div>
                </fieldset>

                <button>Enviar</button>

            </form>
        </div>

        <script>

            let huboError = false;

            const empresa = localStorage.getItem("empresa");
            const CUIT = localStorage.getItem("CUIT");
            const elementos = document.querySelectorAll(".nombreEmpresa");

            elementos.forEach(elemento => {
                elemento.textContent = empresa;
            });

            const form = document.getElementById('form');
            const usuario = document.getElementById('nombreUsuario');
            const apellido = document.getElementById('apellidoUsuario');
            const email = document.getElementById('email');
            const password = document.getElementById('password');
            const password2 = document.getElementById('password2');
            const actividad = document.getElementById('actividad');
            const calDirector = document.getElementById('calDirector');
            const calDirectorio = document.getElementById('calDirectorio');
            const advisory = document.getElementById('advisory');
            const finanEmpeorado = document.getElementById('finanEmpeorado');
            const finanTasas = document.getElementById('finanTasas');
            const finanPercep = document.getElementById('finanPercep');
            const resultados = document.getElementById('resultados');
            const resultadosExtra = document.getElementById('resultadosExtra');
            const subsidiarias = document.getElementById('subsidiarias');
            const estrGerencial = document.getElementById('estrGerencial');
            const formaRemota = document.getElementById('formaRemota');
            const cambioProcesos = document.getElementById('cambioProcesos');
            const tercerizaciones = document.getElementById('tercerizaciones');

            form.addEventListener('submit', e => {
                e.preventDefault();

                checkInputs();
            });

            async function checkInputs() {
                // trim to remove the whitespaces
                const usuarioValue = usuario.value.trim();
                const apellidoValue = apellido.value.trim();
                const emailValue = email.value.trim();
                const passwordValue = password.value.trim();
                const password2Value = password2.value.trim();
                const actividadValue = actividad.value.trim();
                const calDirectorValue = calDirector.value.trim();
                const calDirectorioValue = calDirectorio.value.trim();
                const advisoryValue = advisory.value.trim();
                const finanEmpeoradoValue = finanEmpeorado.value.trim();
                const finanTasasValue = finanTasas.value.trim();
                const finanPercepValue = finanPercep.value.trim();
                const resultadosValue = resultados.value.trim();
                const resultadosExtraValue = resultadosExtra.value.trim();
                const subsidiariasValue = subsidiarias.value.trim();
                const estrGerencialValue = estrGerencial.value.trim();
                const formaRemotaValue = formaRemota.value.trim();
                const cambioProcesosValue = cambioProcesos.value.trim();
                const tercerizacionesValue = tercerizaciones.value.trim();

                if (usuarioValue === '') {
                    setErrorFor(usuario, 'No puede dejar el nombre en blanco');
                } else {
                    setSuccessFor(usuario);
                }

                if (apellidoValue === '') {
                    setErrorFor(apellido, 'No puede dejar el apellido en blanco');
                } else {
                    setSuccessFor(apellido);
                }

                if (emailValue === '') {
                    setErrorFor(email, 'No puede dejar el email en blanco');
                } else if (!isEmail(emailValue)) {
                    setErrorFor(email, 'No ingreso un email válido');
                } else {
                    setSuccessFor(email);
                }

                if (passwordValue === '') {
                    setErrorFor(password, 'La nueva clave no debe estar en blanco.');
                } else {
                    setSuccessFor(password);
                }

                if (password2Value === '') {
                    setErrorFor(password2, 'Repeticion de clave no debe quedar en blanco');
                } else if (passwordValue !== password2Value) {
                    setErrorFor(password2, 'Clave nueva y repetición no coinciden');
                } else {
                    setSuccessFor(password2);
                }

                if (actividadValue === '') {
                    setErrorFor(actividad, 'No puede dejar la actividad en blanco');
                } else {
                    setSuccessFor(actividad);
                }

                if (calDirectorValue === '') {
                    setErrorFor(calDirector, 'No puede quedar en blanco.');
                } else {
                    setSuccessFor(calDirector);
                }

                if (calDirectorioValue === '') {
                    setErrorFor(calDirectorio, 'No puede quedar en blanco.');
                } else {
                    setSuccessFor(calDirectorio);
                }

                if (finanEmpeoradoValue === '') {
                    setErrorFor(finanEmpeorado, 'No puede quedar en blanco.');
                } else {
                    setSuccessFor(finanEmpeorado);
                }

                if (finanTasasValue === '') {
                    setErrorFor(finanTasas, 'No puede quedar en blanco.');
                } else {
                    setSuccessFor(finanTasas);
                }

                if (finanPercepValue === '') {
                    setErrorFor(finanPercep, 'No puede quedar en blanco..');
                } else {
                    setSuccessFor(finanPercep);
                }

                if (resultadosValue === '') {
                    setErrorFor(resultados, 'No puede quedar en blanco..');
                } else {
                    setSuccessFor(resultados);
                }

                if (resultadosExtraValue === '') {
                    setErrorFor(resultadosExtra, 'No puede quedar en blanco.');
                } else {
                    setSuccessFor(resultadosExtra);
                }

                if (subsidiariasValue === '') {
                    setErrorFor(subsidiarias, 'No puede quedar en blanco..');
                } else {
                    setSuccessFor(subsidiarias);
                }

                if (estrGerencialValue === '') {
                    setErrorFor(estrGerencial, 'No puede quedar en blanco..');
                } else {
                    setSuccessFor(estrGerencial);
                }

                if (formaRemotaValue === '') {
                    setErrorFor(formaRemota, 'No puede quedar en blanco.');
                } else {
                    setSuccessFor(formaRemota);
                }

                if (cambioProcesosValue === '') {
                    setErrorFor(cambioProcesos, 'No puede quedar en blanco..');
                } else {
                    setSuccessFor(cambioProcesos);
                }

                if (tercerizacionesValue === '') {
                    setErrorFor(tercerizaciones, 'No puede quedar en blanco..');
                } else {
                    setSuccessFor(tercerizaciones);
                }

                await verificarEmail(emailValue);

                if (huboError) {
                    alert('Debe corregir las observaciones...');
                    huboError = false;
                    window.scrollTo(0, 0); // Mueve la página al inicio
                } else {
                    actualizarInvitado(CUIT, usuarioValue, apellidoValue, passwordValue, emailValue);
                    const datosEmpresa = {
                        CUIT,
                        actividad: actividadValue,
                        calDirector: calDirectorValue,
                        calDirectorio: calDirectorioValue,
                        advisory: advisoryValue,
                        finanEmpeorado: finanEmpeoradoValue,
                        finanTasas: finanTasasValue,
                        finanPercep: finanPercepValue,
                        resultados: resultadosValue,
                        resultadosExtra: resultadosExtraValue,
                        subsidiarias: subsidiariasValue,
                        estrGerencial: estrGerencialValue,
                        formaRemota: formaRemotaValue,
                        cambioProcesos: cambioProcesosValue,
                        tercerizaciones: tercerizacionesValue
                    };
                    crearEmpresa(datosEmpresa)
                    window.location.href = '../registrado.html'
                }
            }

            async function verificarEmail(emailValue) {
                const resultado = await preguntaMail(emailValue);
                if (resultado.exists) {
                    console.log("✅ El email está registrado.");
                    setErrorFor(email, 'Este email ya se encuentra registrado ❌');
                } else {
                    console.log("❌ El email NO está registrado.");
                    setSuccessFor(email);
                }
            }

            async function preguntaMail(emailValue) {
                try {
                    const response = await fetch(`/buscaMail?email=${emailValue}`);

                    if (response.ok) {
                        const mailUser = await response.json(); //registro seccion recibido en formato JSON
                        return { exists: mailUser.exists, records: mailUser.records };
                    } else {
                        console.error("Error al obtener los datos");
                        return { exists: false, records: [] };
                    }

                } catch (error) {
                    console.error("Error al realizar la solicitud:", error);
                    return { exists: false, records: [] };
                }
            }


            function setErrorFor(input, message) {
                const formControl = input.parentElement;
                const small = formControl.querySelector('small');
                formControl.className = 'form-control error';
                small.innerText = message;
                huboError = true;
            }

            function setSuccessFor(input) {
                const formControl = input.parentElement;
                formControl.className = 'form-control success';
            }

            function isEmail(email) {
                return /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(email);
            }

            function actualizarInvitado(CUIT, Nombre, Apellido, password, email) {
                fetch('/api/updateDatosInvitado', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ CUIT, Nombre, Apellido, password, email })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.message === 'Campos actualizados correctamente') {
                            console.log('Invitado actualizado correctamente');
                        } else {
                            console.error('Error al actualizar el invitado');
                        }
                    })
                    .catch(error => {
                        console.error('Error en la solicitud de actualización:', error);
                    });
            }

            function crearEmpresa(datosEmpresa) {
                fetch('/api/creaEmpresa', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(datosEmpresa)
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Respuesta del servidor:', data);
                    })
                    .catch(error => {
                        console.error('Error en la solicitud:', error);
                    });
            }
        </script>
    </div>
</body>

</html>


<!-- // const datosEmpresa = {
    // CUIT,
    // actividadValue,
    // calDirectorValue,
    // calDirectorioValue,
    // advisoryValue,
    // finanEmpeoradoValue,
    // finanTasasValue,
    // finanPercepValue,
    // resultadosValue,
    // resultadosExtraValue,
    // subsidiariasValue,
    // estrGerencialValue,
    // formaRemotaValue,
    // cambioProcesosValue,
    // tercerizacionesValue
    // };   -->